性能测试报告_sbt3.0vs3.2
=====

# 一、背景与环境

## 1.1 双方的实现
比较的双方的技术实现:
1. java17 + sbt3.0(http-nio) + mybatis + mariadb
2. java21 + sbt3.2(虚拟线程) + mybatis + mariadb

其中，sbt3.0 显式配置了tomcat线程池，但都是默认值:
```yml
server:
  tomcat:
    threads:
      # 最大工作线程数,默认200
      max: 200
      # 最小工作线程数,默认10
      min-spare: 10
    # 最大可处理连接数,默认8192
    max-connections: 8192
    # 请求缓冲队列最大长度,默认100
    accept-count: 100
```

而 sbt3.2 则开启了虚拟线程支持:
```yml
spring:
  threads:
    virtual:
      enabled: true
```

使用mariadb作为数据库的原因是，mariadb的jdbc驱动已经适配了Java21的虚拟线程，不会发生线程固定(pinned)。

## 1.2 测试环境
- 数据库: CentOS7 + docker, CPU 6 cores, Mem 16G, HDD 1T, 千兆网卡
- web服务器: CentOS7 + docker, CPU 6 cores, Mem 16G, HDD 1T, 千兆网卡
- 客户机: LinuxMint + Jmeter, 千兆网卡
- 网络环境: 千兆交换机，千兆网线

## 1.3 压力指标
- 并发线程数: 500
- 测试时长: 3min
- 测试轮数: 3轮
- 测试接口: 3个

## 1.4 测试接口
- 单表插入: 单表主键ID为自增字段，插入sql不传入ID字段。
- 条件查询: 测试该接口前清空目标表，并插入10万条数据，该接口每次取1到99900之间的随机整数并加10，作为id范围条件查询10条数据。(因为千兆网卡按字节流量是125MiB/s，而该表10万条数据的size大约是18M，为了避免并发查询时带宽成为瓶颈，这里只取10条数据。)
- 主键查询: 从10万数据的单表中，用随机ID查询一条数据。

# 二、测试结果

## 2.1 单表插入

500并发单表插入一条数据，跑3分钟。

| project | 样本 | 平均值 | 中位数 | 90% 百分位 | 95% 百分位 | 99% 百分位 | 最小值 | 最大值 | 异常 % | 吞吐量 | 接收 KB/sec | 标准偏差 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| sbt3.0 | 945709 | 92 | 68 | 135 | 212 | 421 | 10 | 2124 | 0.00% | 5250.8 | 1060.2 | 90.98 |
|  | 927213 | 94 | 68 | 135 | 217 | 423 | 10 | 4955 | 0.00% | 5148.2 | 1039.5 | 121.01 |
|  | 969803 | 90 | 68 | 134 | 204 | 404 | 9 | 2053 | 0.00% | 5384.0 | 1087.2 | 75.85 |
| sbt3.2 | 960105 | 91 | 85 | 101 | 118 | 185 | 9 | 1736 | 0.00% | 5328.3 | 1076.5 | 66.79 |
|  | 972078 | 90 | 85 | 100 | 117 | 185 | 11 | 1587 | 0.00% | 5397.3 | 1090.4 | 54.82 |
|  | 943348 | 92 | 85 | 101 | 118 | 184 | 11 | 2360 | 0.00% | 5238.0 | 1058.2 | 90.53 |


## 2.2 条件查询

500并发从一张10万条数据的单表查询随机ID+10条数据(randomID <= id <= randomID+10)，不用全表查询是为了控制流量不要超过带宽(千兆网卡+网线+交换机)

| project | 样本 | 平均值 | 中位数 | 90% 百分位 | 95% 百分位 | 99% 百分位 | 最小值 | 最大值 | 异常 % | 吞吐量 | 接收 KB/sec | 标准偏差 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| sbt3.0 | 4265319 | 20 | 20 | 27 | 31 | 47 | 0 | 1087 | 0.00% | 23686.5 | 86310.6 | 9.14 |
|  | 4260876 | 20 | 20 | 27 | 32 | 48 | 0 | 1047 | 0.00% | 23663.6 | 86227.4 | 9.17 |
|  | 4247950 | 20 | 20 | 27 | 32 | 49 | 0 | 1105 | 0.00% | 23592.9 | 85969.5 | 9.83 |
| sbt3.2 | 4311621 | 20 | 16 | 43 | 56 | 83 | 0 | 1086 | 0.00% | 23946.9 | 87292.8 | 17.06 |
|  | 4314222 | 20 | 15 | 44 | 56 | 83 | 0 | 1047 | 0.00% | 23937.3 | 87258.0 | 17.13 |
|  | 4314194 | 20 | 17 | 43 | 55 | 82 | 0 | 1106 | 0.00% | 23961.9 | 87347.6 | 16.91 |

## 2.3 主键查询

500并发从一张10万条数据的单表按随机ID做主键查询(id = randomID)。

| project | 样本 | 平均值 | 中位数 | 90% 百分位 | 95% 百分位 | 99% 百分位 | 最小值 | 最大值 | 异常 % | 吞吐量 | 接收 KB/sec | 标准偏差 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| sbt3.0 | 7402574 | 11 | 10 | 14 | 18 | 88 | 0 | 1041 | 0.00% | 41103.9 | 19374.1 | 13.96 |
|  | 7151574 | 12 | 10 | 14 | 18 | 112 | 0 | 1015 | 0.00% | 39719.1 | 18721.3 | 15.16 |
|  | 7171646 | 12 | 10 | 14 | 18 | 113 | 0 | 1069 | 0.00% | 39827.7 | 18772.4 | 15.65 |
| sbt3.2 | 7382616 | 11 | 10 | 21 | 27 | 43 | 0 | 1049 | 0.00% | 41004.3 | 19326.9 | 8.22 |
|  | 7376494 | 11 | 10 | 21 | 27 | 43 | 0 | 1078 | 0.00% | 40967.8 | 19309.7 | 8.69 |
|  | 7356126 | 11 | 10 | 21 | 27 | 43 | 0 | 1040 | 0.00% | 40856.2 | 19257.1 | 8.15 |


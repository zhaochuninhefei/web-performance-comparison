性能测试报告
=====

# 一、概述
对以下项目执行相同硬件环境下相同的压力测试(jmeter):
- `web-pm-dotnet` : dotnet WEB测试项目, 无额外的性能调优措施
- `web-pm-gin` : go+gin+gorm WEB测试项目, 无额外的性能调优措施
- `web-pm-quarkus` : kotlin+quarkus+hibernate WEB测试项目, 无额外的性能调优措施
- `web-pm-rust` : rust WEB测试项目, 无额外的性能调优措施
- `web-pm-springboot` : java+springboot+mybatis WEB测试项目，显式设置了tomcat线程池配置，但均为默认配置(如最大线程数为200)
- `web-pm-vertx` : kotlin+vertx WEB测试项目，设置了web请求监听Verticle的实例数量为当前平台CPU的processor数量
- `web-pm-vertx-java`   java+vertx WEB测试项目，设置了web请求监听Verticle的实例数量为当前平台CPU的processor数量


注意:
1. 应用服务、数据库和jmeter都在一台机器(i7-12700H + 32G 内存 + 1T SSD)上。
2. 数据库为MySQL8.0.22社区版，docker容器，无额外调优。
3. 各应用服务的数据库连接池最大连接数统一为100。
4. 应用服务均直接命令行本地启动。
5. `web-pm-vertx`提供了jar包和native两种部署方式，分别是`web-pm-vertx-jar`和`web-pm-vertx-native`。
6. `web-pm-vertx-java`只测试了jar包部署方式。
7. `web-pm-quarkus`只测试了native部署方式。


从结果能看出来：
1. vertx这样的反应式编程框架在高并发环境下的IO密集型应用中具备较大优势，能够用更少的CPU提供更高的并发能力，并且偏差更小，意味着增加硬件能带来更线性的性能提升。
2. 对于vertx来说，使用kotlin或java在性能上并无明显差异。(不过使用kt大约可以减轻一点反应式编程的心智负担。)
3. 目前使用graalVM社区版编译的native应用，可能会受到SerialGC的拖累导致性能表现下降，甚至不如充分热机后的JVM。graalVM社区版目前的优势应该还是在启动速度以及内存占用上，也就是FaaS方面有优势。
4. go+gin+gorm是一套性能表现稳定的框架，在本次测试中，虽然比不上vertx，但各项测试成绩也都比较优秀，很稳定。
5. springboot在硬件相对较好时，经过简单的调优即可获得不错的性能表现。
6. dotnet、rust的表现不尽如人意，可能还是我们的代码没有找到正确的实现方式，或者需要一点额外的调优配置。


# 二、性能表现汇总

## 2.1 单表插入API表现汇总
5000个并发线程不断调用`/account/add`接口向`accounts`表插入一条数据，持续3分钟，每个项目都执行3轮，取其吞吐量最高的一次。


| Label | # 样本 | 平均值 | 中位数 | 90% 百分位 | 95% 百分位 | 99% 百分位 | 最小值 | 最大值 | 异常 % | 吞吐量 | 接收 KB/sec | 标准偏差 | CPU使用率 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| web-pm-dotnet | 1188585 | 738 | 735 | 801 | 847 | 877 | 10 | 3300 | 0.00% | 6580.4 | 1247.1 | 81.22 | 81% |
| web-pm-gin | 3076139 | 287 | 26 | 1533 | 1616 | 1867 | 0 | 6519 | 0.00% | 16870.4 | 2811.5 | 575.79 | 62% |
| web-pm-quarkus | 1609780 | 547 | 559 | 663 | 680 | 704 | 2 | 1040 | 0.00% | 8857.9 | 1135.9 | 113.34 | 38% |
| web-pm-rust | 2266609 | 393 | 26 | 414 | 740 | 15793 | 1 | 65599 | 0.00% | 11588.8 | 1748.6 | 2112.91 | 45% |
| web-pm-springboot | 3316082 | 266 | 315 | 363 | 375 | 401 | 2 | 1204 | 0.00% | 18187.3 | 3688.3 | 129.31 | 72% |
| web-pm-vertx-jar | 3686523 | 239 | 234 | 278 | 287 | 312 | 2 | 880 | 0.00% | 20248.7 | 2327.4 | 48.25 | 64% |
| web-pm-vertx-native | 3323612 | 265 | 248 | 367 | 396 | 440 | 2 | 796 | 0.00% | 18247.5 | 2096.8 | 67.07 | 62% |
| web-pm-vertx-java | 3678561 | 239 | 235 | 280 | 289 | 318 | 1 | 831 | 0.00% | 20211.1 | 2323.1 | 49.48 | 64% |


这里表现最好的是vertx，其次是springboot。两者都算有那么一点点调优措施。

其他的项目里，`web-pm-gin`表现算是正常，但其他的如`web-pm-dotnet`、`web-pm-quarkus`、`web-pm-rust`，他们的表现不尽如人意。可能还是我们的代码没有找到正确的实现方式，或者需要一点额外的调优配置。

更具体的测试数据可参考: 
```
jmeter/*-account_add/5000_3m_*_aggregate.csv
jmeter/*-account_add/5000_3m_*_monitor_report.png
```

## 2.2 1000件全表查询API表现汇总
5000个并发线程不断调用`/account/list`接口对`accounts`表执行全表查询，持续3分钟，每个项目都执行3轮，取其吞吐量最高的一次。
> `accounts`表此时全表件数为1000件。

| Label | # 样本 | 平均值 | 中位数 | 90% 百分位 | 95% 百分位 | 99% 百分位 | 最小值 | 最大值 | 异常 % | 吞吐量 | 接收 KB/sec | 标准偏差 | CPU使用率 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| web-pm-dotnet | 197610 | 4489 | 4630 | 4863 | 4921 | 5031 | 10 | 5319 | 0.00% | 1070.4 | 325134.7 | 704.22 | 82% |
| web-pm-gin | 332765 | 2699 | 222 | 1036 | 2556 | 118036 | 7 | 180911 | 0.00% | 1785.3 | 594567.7 | 17834.57 | 91% |
| web-pm-quarkus | 79610 | 11378 | 12588 | 12901 | 13040 | 13408 | 13 | 15400 | 0.00% | 415.6 | 126208.0 | 2546.61 | 36% |
| web-pm-rust | 196890 | 4782 | 812 | 901 | 945 | 130768 | 8 | 222087 | 1.31% | 805.5 | 241463.3 | 21814.27 | 30% |
| web-pm-springboot | 296372 | 3057 | 1203 | 9322 | 10764 | 11636 | 5 | 23878 | 0.00% | 1321.0 | 416746.7 | 3649.36 | 86% |
| web-pm-vertx-jar | 494883 | 1824 | 1915 | 2001 | 2030 | 2108 | 3 | 3109 | 0.00% | 2583.8 | 847731.2 | 363.08 | 85% |
| web-pm-vertx-native | 90795 | 9971 | 10954 | 11537 | 11702 | 12021 | 7 | 12675 | 0.00% | 473.3 | 155303.4 | 2587.65 | 27% |
| web-pm-vertx-java | 507114 | 1779 | 1903 | 1996 | 2032 | 2125 | 4 | 3155 | 0.00% | 2596.2 | 851796.6 | 412.35 | 90% |


这里表现最好的还是vertx，其次是gin。

`web-pm-vertx-native`和`web-pm-quarkus`表现一样的拉胯，而这两者都是native部署，都使用的社区版的graalVM，再加上正好这个接口在高并发调用时确实会快速大量分配内存，这就很难让人不怀疑是社区版graalVM只支持SerialGC的锅了。。。

更具体的测试数据可参考: 
```
jmeter/*-account_list/5000_3m_*_aggregate.csv
jmeter/*-account_list/5000_3m_*_monitor_report.png
```


## 2.3 主键查询API表现汇总
5000个并发线程不断调用`/account/query`接口对`accounts`表执行主键查询，持续3分钟，每个项目都执行3轮，取其吞吐量最高的一次。
> `accounts`表此时全表件数为1000件。

| Label | # 样本 | 平均值 | 中位数 | 90% 百分位 | 95% 百分位 | 99% 百分位 | 最小值 | 最大值 | 异常 % | 吞吐量 | 接收 KB/sec | 标准偏差 | CPU使用率 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| web-pm-dotnet | 1580098 | 559 | 518 | 928 | 1014 | 1243 | 1 | 7697 | 0.00% | 8608.2 | 3850.1 | 277.20 | 54% |
| web-pm-gin | 7486008 | 118 | 20 | 732 | 780 | 836 | 0 | 3858 | 0.00% | 40765.9 | 18411.8 | 255.16 | 81% |
| web-pm-quarkus | 5066349 | 174 | 169 | 188 | 231 | 422 | 0 | 639 | 0.00% | 27595.1 | 10671.5 | 55.34 | 72% |
| web-pm-rust | 5689415 | 157 | 22 | 27 | 28 | 4065 | 0 | 131201 | 0.00% | 24512.9 | 10030.9 | 1453.94 | 64% |
| web-pm-springboot | 8070512 | 110 | 137 | 166 | 269 | 408 | 0 | 3671 | 0.00% | 43006.5 | 20285.3 | 96.43 | 88% |
| web-pm-vertx-jar | 8151193 | 108 | 107 | 153 | 238 | 340 | 0 | 1033 | 0.00% | 44447.6 | 17666.2 | 60.52 | 77% |
| web-pm-vertx-native | 6200705 | 142 | 138 | 172 | 280 | 307 | 0 | 659 | 0.00% | 33817.7 | 13441.2 | 52.09 | 68% |
| web-pm-vertx-java | 7997326 | 110 | 109 | 170 | 256 | 360 | 0 | 1071 | 0.00% | 43512.7 | 17294.6 | 66.67 | 79% |


这里vertx, springboot, gin的表现都很好，其他的都有明显差距，尤其`web-pm-dotnet`很拉胯，可能还是我们的代码没有找到正确的实现方式，或者需要一点额外的调优配置。

更具体的测试数据可参考: 
```
jmeter/*-account_query/5000_3m_*_aggregate.csv
jmeter/*-account_query/5000_3m_*_monitor_report.png
```


## 2.4 内存读取API表现汇总
5000个并发线程不断调用`/asset/query`接口，直接从内存返回一条数据，持续3分钟，每个项目都执行3轮，取其吞吐量最高的一次。


| Label | # 样本 | 平均值 | 中位数 | 90% 百分位 | 95% 百分位 | 99% 百分位 | 最小值 | 最大值 | 异常 % | 吞吐量 | 接收 KB/sec | 标准偏差 | CPU使用率 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| web-pm-dotnet | 13920690 | 63 | 1 | 210 | 297 | 436 | 0 | 3326 | 0.00% | 76058.1 | 14780.8 | 115.13 | 80% |
| web-pm-gin | 13677288 | 64 | 8 | 312 | 351 | 417 | 0 | 1542 | 0.00% | 75355.7 | 12804.6 | 124.68 | 62% |
| web-pm-quarkus | 17495594 | 50 | 1 | 199 | 269 | 441 | 0 | 1046 | 0.00% | 95669.2 | 12706.1 | 100.53 | 81% |
| web-pm-rust | 22852510 | 40 | 0 | 6 | 23 | 481 | 0 | 131228 | 0.01% | 110346.9 | 17147.6 | 1409.76 | 52% |
| web-pm-springboot | 15935702 | 55 | 6 | 186 | 260 | 434 | 0 | 17799 | 0.00% | 87420.0 | 18098.7 | 131.76 | 79% |
| web-pm-vertx-jar | 16648805 | 53 | 1 | 165 | 264 | 445 | 0 | 743 | 0.00% | 91360.5 | 10884.7 | 94.60 | 70% |
| web-pm-vertx-native | 15587216 | 56 | 4 | 172 | 282 | 464 | 0 | 960 | 0.00% | 85594.7 | 10197.8 | 99.90 | 72% |
| web-pm-vertx-java | 16087648 | 54 | 1 | 167 | 266 | 442 | 0 | 848 | 0.00% | 88131.2 | 10500.0 | 94.77 | 70% |


这里rust表现最好，其他的也不差。

更具体的测试数据可参考: 
```
jmeter/*-asset_query/5000_3m_*_aggregate.csv
jmeter/*-asset_query/5000_3m_*_monitor_report.png
```

# 三、测试环境
本章节用于记述测试资源与思路。

## 3.1 测试机(物理机)资源
- CPU : 12th Gen Intel(R) Core(TM) i7-12700H
- 内存 : 32G
- 磁盘 : SSD 1T
- OS : Linux Mint 20.3
- jmeter : 5.1.1

## 3.2 语言、框架与工具的版本
语言、框架与工具及其版本信息如下：
- golang版本 : v1.17.5
- gin版本 : v1.8.1
- gorm版本 : v1.24.2
- java版本 : openJDK-17.0.3
- springboot版本 : 3.0.0
- mybatis-spring-boot-starter版本 : 3.0.1
- kotlin版本 : 1.7.21
- quarkus版本 : 2.15.1.Final
- hibernate版本 : 5.6.14.Final
- vertx版本 : 4.3.7
- JMeter版本 : 5.1.1
- dotnet版本 : 6.0.404
- rust版本 : cargo 1.66.0




